<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zdjf.dao.product.productBuy">
	<select id="selectProductBuyPage" resultType="com.zdjf.domain.product.ProductBuyVo">
		<trim prefix="select" suffixOverrides=",">
		<include refid="columns"/>
		</trim> 
		from
		zd_product_buy
		where 1=1
		<include refid="conds" />
		<if test="status==null||status==0">
			and status in (1,2,-2)
		</if>
		order by id desc
		limit #{firstrownum}, #{limit}
	</select>
	<select id="selectProductBuyCount" resultType="java.lang.Long">
		select
		count(id)
		from zd_product_buy
		where 1=1
		<include refid="conds" />
		<if test="status==null||status==0">
			and status in (1,2,-2)
		</if>
	</select>
	
	<select id="selectMyProductBuyList" parameterType="java.util.Map" resultType="com.zdjf.domain.product.ProductBuyVo">
		select * 
		from zd_product_buy f 
		where 1=1 and user_id = #{user_id} 
		<if test="beginDate != null and beginDate != ''">
		 and create_time &gt;= #{beginDate}
		
		</if>
		<if test="endDate != null and endDate != ''">
		 and create_time &lt;= #{endDate}
		
		</if>
		<choose>
        <when test="status !=null and status != ''">
            and status = #{status}
        </when>
        <otherwise>
			and status in (-1,1,2)
        </otherwise>
    	</choose>
    	 order by create_time desc limit #{firstrownum}, #{limit}
	</select>
	
	<select id="selectMyProductBuyListCount" resultType="java.lang.Long">
		select
		count(id)
		from zd_product_buy
		where 1=1 and user_id = #{user_id} 
		<if test="beginDate != null and beginDate != ''">
		 and create_time &gt;= #{beginDate}
		
		</if>
		<if test="endDate != null and endDate != ''">
		 and create_time &lt;= #{endDate}
		
		</if>
		<choose>
        <when test="status !=null and status != ''">
            and status = #{status}
        </when>
        <otherwise>
            
        </otherwise>
    	</choose>
	</select>
	
	<select id="selectProductBuyById" resultType="com.zdjf.domain.product.ProductBuy">
		<trim prefix="select" suffixOverrides=",">
		<include refid="columns"/>
		</trim> 
		from zd_product_buy
		where 1=1
		and id=#{id}
	</select>
	<select id="deleteProductBuyById" parameterType="long">
			delete from zd_product_buy where id=#{id}
	</select>
	<select id="updateProductBuyById" parameterType="com.zdjf.domain.product.ProductBuy">
		update zd_product_buy
		<trim prefix="set" suffixOverrides=",">
			<if test="id != null and id != ''">  id = #{id},</if>
			<if test="user_id != null and user_id != ''">  user_id = #{user_id},</if>
			<if test="phone != null and phone != ''">  phone = #{phone},</if>
			<if test="product_id != null and product_id != ''">  product_id = #{product_id},</if>
			<if test="product_name != null and product_name != ''">  product_name = #{product_name},</if>
			<if test="type != null and type != ''">  type = #{type},</if>
			<if test="create_time != null">  create_time = #{create_time},</if>
			<if test="pay_time != null">  pay_time = #{pay_time},</if>
			<if test="close_time != null">  close_time = #{close_time},</if>
			<if test="return_date != null">  return_date = #{return_date},</if>
			<if test="start_date != null">  start_date = #{start_date},</if>
			<if test="will_end_date != null">  will_end_date = #{will_end_date},</if>
			<if test="end_date != null">  end_date = #{end_date},</if>
			<if test="will_income_days != null and will_income_days != ''">  will_income_days = #{will_income_days},</if>
			<if test="income_days != null and income_days != ''">  income_days = #{income_days},</if>
			<if test="status != null and status != ''">  status = #{status},</if>
			<if test="bid_status != null and bid_status != ''">  bid_status = #{bid_status},</if>
			<if test="product_interest != null and product_interest != ''">  product_interest = #{product_interest},</if>
			<if test="user_coupon_id != null and user_coupon_id != ''">  user_coupon_id = #{user_coupon_id},</if>
			<if test="user_gift_id != null and user_gift_id != ''">  user_gift_id = #{user_gift_id},</if>
			<if test="amount != null and amount != ''">  amount = #{amount},</if>
			<if test="will_income != null and will_income != ''">  will_income = #{will_income},</if>
			<if test="incomed != null and incomed != ''">  incomed = #{incomed},</if>
			<if test="fee != null and fee != ''">  fee = #{fee},</if>
			<if test="coin != null and coin != ''">  coin = #{coin},</if>
			<if test="act_pay_money != null and act_pay_money != ''">  act_pay_money = #{act_pay_money},</if>
			<if test="reconciliation_id != null and reconciliation_id != ''">  reconciliation_id = #{reconciliation_id},</if>
			<if test="req_source != null and req_source != ''">  req_source = #{req_source},</if>
			<if test="first_buy_flag != null and first_buy_flag != ''">  first_buy_flag = #{first_buy_flag},</if>
			<if test="freeze_trx_id != null and freeze_trx_id != ''">  freeze_trx_id = #{freeze_trx_id},</if>
			<if test="buy_id != null and buy_id != ''">  buy_id = #{buy_id},</if>
			<if test="uid != null and uid != ''">  uid = #{uid},</if>
			<if test="order_id != null and order_id != ''">  order_id = #{order_id},</if>
			<if test="trade_no != null and trade_no != ''">  trade_no = #{trade_no},</if>
			<if test="inviter_phone != null and inviter_phone != ''">  inviter_phone = #{inviter_phone},</if>
			<if test="is_debt != null and is_debt != ''">  is_debt = #{is_debt},</if>
		</trim>
		where 1=1
		and id=#{id}
	</select>
	<!-- 已投款 -->
	<select id="selectAmountByProductId" resultType="java.util.Map">
		select product_id,ifnull(sum(amount), 0) as can_buy_money 
		from zd_product_buy pb where  pb.`status` in (0,-1)
		group by pb.product_id
	</select>
	<select id="selectCouponForPayByUid" resultType="java.lang.Double">
		select sum(amount-act_pay_money) from zd_product_buy where `status` in (1,2) and user_id=#{user_id}
	</select>
	
	<select id="selectConductListByUid" resultType="java.util.Map">
		select 
				t.*
			from 
				zd_product_buy t 
			where
				1 = 1  
				and user_id=${user_id} 
				<!-- 全部 -->
				<if test="status==0">
					and (t.status in (1,2,7) or (t.status=-1 and t.create_time>=DATE_ADD(now(),INTERVAL -24 hour)))
				</if>
				<!-- 投资中 -->
				<if test="status==1">
					and t.status > 0
				</if>
				<!-- 履约中 -->
				<if test="status==2">
					and (t.status = 1  or t.status = 7 or (t.status=-1 and t.create_time>=DATE_ADD(now(),INTERVAL -24 hour)))
				</if>
				<!-- 已回款 -->
				<if test="status==3">
					and t.status = 2
				</if>
				<!-- 流标 -->
				<if test="status==4">
					and t.status = -7
				</if>
				order by t.status asc,t.create_time desc
				limit #{firstrownum}, #{limit}
	</select>
	<select id="selectConductListByUidCn" resultType="java.lang.Long">
		select 
				count(0)
			from 
				zd_product_buy t 
			where
				1 = 1  
				and user_id=${user_id} 
				<!-- 全部 -->
				<if test="status==0">
					and (t.status in (1,2,7) or (t.status=-1 and t.create_time>=DATE_ADD(now(),INTERVAL -24 hour)))
				</if>
				<!-- 投资中 -->
				<if test="status==1">
					and t.status > 0
				</if>
				<!-- 履约中 -->
				<if test="status==2">
					and (t.status = 1  or t.status = 7 or (t.status=-1 and t.create_time>=DATE_ADD(now(),INTERVAL -24 hour)))
				</if>
				<!-- 已回款 -->
				<if test="status==3">
					and t.status = 2
				</if>
				<!-- 流标 -->
				<if test="status==4">
					and t.status = -7
				</if>
	</select>
	<select id="selectProductBuyList" resultType="com.zdjf.domain.product.ProductBuy" parameterType="java.util.Map">
		select phone,amount,product_interest,user_coupon_id,will_income,pay_time,req_source from zd_product_buy where 1=1
		and product_id=#{product_id} and status=1
		order by pay_time desc
	</select>
	
	<select id="selectProductBuyYesterday" resultType="com.zdjf.domain.product.ProductBuy" parameterType="java.util.Map">
		select * 
		from zd_product_buy
		where 1=1
		and status=#{status}
		and user_id=#{user_id}
		<if test="start_date != null"  >
			and UNIX_TIMESTAMP(create_time) &gt;= UNIX_TIMESTAMP(#{start_date,jdbcType=TIMESTAMP})
		</if>
		<if test="end_date != null"  >
			and UNIX_TIMESTAMP(create_time) &lt;= UNIX_TIMESTAMP(#{end_date,jdbcType=TIMESTAMP})
		</if>
	</select>
	
	<select id="selectUserBuyList" resultType="map">
		select sum(amount-act_pay_money+incomed) incomed,DATE_FORMAT( end_date, '%Y-%m') date,status from zd_product_buy 
		where (status=1 or status=2) and user_id=#{user_id} 
	</select>
	
	<select id="selectUserMonthBuyList" resultType="com.zdjf.domain.product.ProductBuy" parameterType="java.util.Map">
		select * from zd_product_buy where (status=1 or status=2) and end_date &gt;= #{beginDate} and end_date &lt;= #{endDate}
		and user_id=#{user_id} group by end_date,status order by create_time asc
	</select>
	<select id="selectPurchasePage" resultType="java.util.Map">
		<trim prefix="select" suffixOverrides=",">
		<include refid="columns"/>
		</trim> 
		from
		zd_product_buy
		where 1=1
		<if test="user_id!=null and user_id!=''">
			and user_id=#{user_id}
		</if>
		<if test="product_id!=null and product_id!=''">
			and product_id=#{product_id}
		</if>
		<if test="regSource!=null and regSource!=''">
			and req_source=#{regSource}
		</if>
		<if test="status!=null and status!=''">
			and status=#{status}
		</if>
		<if test="createStartTime!=null and createStartTime!=''">
			and DATE_FORMAT(create_time,'%Y-%m-%d') &gt;#{createStartTime}
		</if>
		<if test="createEndTime !=null and createEndTime !=''">
			and DATE_FORMAT(create_time,'%Y-%m-%d') &lt;#{createEndTime}
		</if>
		<if test="payStartTime!=null and payStartTime!=''">
			and DATE_FORMAT(pay_time,'%Y-%m-%d') &gt;#{payStartTime}
		</if>
		<if test="payEndTime !=null and payEndTime !=''">
			and DATE_FORMAT(pay_time,'%Y-%m-%d') &lt;#{payEndTime}
		</if>
		<if test="productName !=null and productName !=''">
			and product_name like #{productName}
		</if>
		order by id desc
		limit #{firstrownum}, #{limit}
	</select>
	<select id="selectPurchaseCount" resultType="java.lang.Long">
		select
		count(id)
		from zd_product_buy
		where 1=1
		<include refid="conds" />
	</select>
	<!-- 邀请人汇总 -->
	<select id="selectInviterPhoneSum" resultType="java.util.Map">
		select count(user_id) inviter_num,sum(act_pay_money) total_pay 
		from zd_product_buy 
		where inviter_phone=${inviter_phone} 
	</select>
	<select id="selectInviterPhone" resultType="java.util.Map">
		select * 
		from zd_product_buy 
		where inviter_phone=${inviter_phone} 
		order by pay_time desc
		limit #{firstrownum}, #{limit}
	</select>
	<select id="selectInviterPhoneCn" resultType="java.lang.Long">
		select count(0) 
		from zd_product_buy 
		where inviter_phone=${inviter_phone} 
	</select>
	<select id="selectInvestor" resultType="java.lang.Long">
		select DISTINCT user_id from zd_product_buy where status in (1,2)
	</select>
	<!--用户累计投资额-->
	<select id="selectUserTotalInvest" resultType="java.lang.Long">
		select sum(amount) from zd_product_buy where status in (1,2) and user_id = #{userId}
	</select>
	<!--用户首次投资>=1000-->
	<select id="selectUserFirstInvest" resultType="java.lang.Long">
		select 1 from zd_product_buy where status in (1,2) and user_id = #{userId} and amount>=1000
	</select>
	<!--统计用户是否投资过-->
	<select id="selectUserIsInvested" resultType="java.lang.Long">
		select 1 from zd_product_buy where status in (1,2) and user_id = #{userId}
	</select>
	<!--统计在指定时间范围内投资额在前10位的用户-->
	<select id="selectNewYearInvt" resultType="java.util.Map">
		SELECT SUM(amount) total,FORMAT(SUM(amount),2) amt,insert(phone, 4, 4, '****') phone from zd_product_buy
		where DATE_FORMAT(pay_time,'%Y-%m-%d') &gt;=  #{startDate}
		and DATE_FORMAT(pay_time,'%Y-%m-%d') &lt;= #{endDate}
		and status in (1,2) GROUP BY phone ORDER BY total desc,pay_time asc limit 0,10
	</select>
	<select id="staUserProductBuy" resultType="java.lang.Double">
		SELECT SUM(amount) from zd_product_buy where status BETWEEN 1 and 2
	</select>
	<!--累计投资笔数-->
	<select id="staInvtNum" resultType="java.lang.Long">
		SELECT COUNT(1) from zd_product_buy where status BETWEEN 1 and 2
	</select>
	<!--总投资人数-->
	<select id="staInvtUsers" resultType="java.lang.Long">
		SELECT COUNT(1) from (SELECT 1 from zd_product_buy where status BETWEEN 1 and 2 GROUP BY user_id) a
	</select>
	<!--女性总投资人数-->
	<select id="staInvtWomanUsers" resultType="java.lang.Long">
		SELECT COUNT(1) from (
			SELECT 1 from zd_product_buy b INNER JOIN zd_user u on b.user_id = u.id
			where if(length(u.idcard_no)=18, cast(substring(u.idcard_no,17,1) as UNSIGNED)%2, if(length(u.idcard_no)=15,cast(substring(u.idcard_no,15,1) as UNSIGNED)%2,3)) = 0
			and b.status BETWEEN 1 and 2 GROUP BY b.user_id
		) a;
	</select>
	<!--男性总投资人数-->
	<select id="staInvtManUsers" resultType="java.lang.Long">
		SELECT COUNT(1) from (
			SELECT 1 from zd_product_buy b INNER JOIN zd_user u on b.user_id = u.id
			where if(length(u.idcard_no)=18, cast(substring(u.idcard_no,17,1) as UNSIGNED)%2, if(length(u.idcard_no)=15,cast(substring(u.idcard_no,15,1) as UNSIGNED)%2,3)) = 1
			and b.status BETWEEN 1 and 2 GROUP BY b.user_id
		) a;
	</select>

	<!--查询用户当日累计投资额-->
	<select id="selectUserInvestByCurDay" resultType="java.lang.Double">
		SELECT SUM(amount) FROM  zd_product_buy
		WHERE  DATE_FORMAT(pay_time,'%Y-%m-%d') = DATE_FORMAT(NOW(),'%Y-%m-%d')
			AND user_id = ${userId} AND status BETWEEN 1 AND 2
	</select>

</mapper>